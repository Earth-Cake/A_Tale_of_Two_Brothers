#textdomain wesnoth-atotb

[scenario]
    name= _ "The Strike on Wintervale"
    map_file=01_The_Strike_on_Wintervale.map
    id=01_The_Strike_on_Wintervale
    next_scenario=02_An_Unprecedented_Alliance

    victory_when_enemies_defeated=no

    {DEFAULT_MUSIC_PLAYLIST}
    {DEFAULT_SCHEDULE}
    {TURNS 23 20 17}

    # Village of Wintervale is placed somewhere north of Wesmere
    # and southeast of Glamdrol.

    [side]
        side=1
        controller=human
        type=Red Mage
        id=Baran
        name= _ "Baran"
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        canrecruit=yes
        recruit=Spearman, Bowman, Woodsman
        team_name=good_guys
        user_team_name= _ "Humans"
        x,y=16,19
        fog=yes

        {GOLD 100 90 80}
    [/side]

    [side]
        side=2
        controller=human
        type=Knight
        id=Arvith
        name= _ "Arvith"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        canrecruit=yes
        recruit=Spearman, Bowman, Woodsman
        team_name=good_guys
        user_team_name= _ "Humans"
        x,y=22,21
        fog=yes

        {GOLD 100 90 80}
    [/side]

    [side]
        side=3
        controller=ai
        type=Orcish Warrior
        id=Grakhas
        name= _ "Grakhas"
        canrecruit=yes
        recruit=Orcish Grunt, Orcish Archer, Wolf Rider, Goblin Spearman
        team_name=bad_guys
        user_team_name= _ "Enemies"
        x,y=11,5
        # This side is hidden until one unit of this side is spotted
        hidden=yes
        persistent=yes
        # This key is for multiplayer only,
        # and it disallows player(s) to modify
        # side and it is hidden during game
        # creation.
        allow_player=no

        {GOLD 200 250 300}
        [ai]
            [avoid]
                x,y=32,7
                radius=1
            [/avoid]
            recruitment_pattern=fighter,fighter,archer,scout
        [/ai]
    [/side]

    [side]
        side=4
        controller=null
        no_leader=yes
        hidden=yes
        team_name=neutral_guys
        user_team_name= _ "Other"
        allow_player=no
    [/side]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Find out what is wrong"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _ "Find out what is wrong"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]

        {GENERIC_UNIT 1 Spearman 7 23}
        {GENERIC_UNIT 2 Spearman 24 15}

        {CAPTURE_VILLAGE 1 10 21}
        {CAPTURE_VILLAGE 1 13 23}
        {CAPTURE_VILLAGE 1 7 28}
        {CAPTURE_VILLAGE 1 15 26}
        {CAPTURE_VILLAGE 1 20 27}
        {CAPTURE_VILLAGE 1 18 17}
        {CAPTURE_VILLAGE 2 18 21}
        {CAPTURE_VILLAGE 2 26 20}
        {CAPTURE_VILLAGE 2 27 24}
        {CAPTURE_VILLAGE 2 30 20}
        {CAPTURE_VILLAGE 2 30 17}
        {CAPTURE_VILLAGE 2 32 15}
        {CAPTURE_VILLAGES 3 11 5 7}

        [label]
            x,y=30,17
            text= _ "Barn"
            side=0
        [/label]

        {PLACE_IMAGE scenery/well.png 6 28}
        {PLACE_IMAGE scenery/well.png 20 18}

        {VARIABLE number_of_razed_villages $number}
        {VARIABLE balin_met_0 yes}
    [/event]

    [event]
        name=start
        # I think brothers should talk about this fog and mage feels trouble - they should summon warriors
    [/event]

    [event]
        name=sighted
        [filter]
            side=3
        [/filter]
        [message]
            speaker=$second_unit.id
            message= _ "Orcs!"
        [/message]

        # Now reveal side
        [modify_side]
            [filter]
                side=3
            [/filter]
            hidden=no
        [/modify_side]
        # I think there should be some talk about orcs, and that this doesn't look like a typical raid

        [message]
            speaker=Arvith
            message= _ "If they capture our barn they will burn it, and we will not be able to survive winter! Men, guard it with your lives!"
        [/message]

        {HIGHLIGHT_HEX 30 17 misc/highlight-hex.png ()}

        [objectives]
            side=1
            [objective]
                description= _ "Drive orcs away"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                description= _ "Orcs capture the barn"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]

        [objectives]
            side=2
            [objective]
                description= _ "Drive orcs away"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Orcs capture the barn"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            [filter_side]
                side=3
            [/filter_side]
            [filter_location]
                terrain=*^Vh,*^Vc
            [/filter_location]
        [/filter]
        {MODIFY_TERRAIN Rd  $x1 $y1}

        # This code provides random placement
        # of sceneries below when conditions are met.
        {RANDOM (scenery/village-human-burned1.png, scenery/village-human-burned2.png, scenery/village-human-burned4.png)}
        {PLACE_IMAGE $random $x1 $y1}

        # Variable operation
        {VARIABLE_OP number_of_razed_villages add 1}

        [if]
            [variable]
                name=number_of_razed_villages
                equals=1
            [/variable]
            [then]
                [message]
                    speaker=Baran
                    # TODO: make a better explanation
                    message= _ "They are burning our villages! If they burn too many of them, we will not be able to recover!"
                [/message]

                {OBJECTIVES_ONE_VILLAGE_RAZED}
            [/then]
        [/if]

        [if]
            [variable]
                name=number_of_razed_villages
                equals=2
            [/variable]
            [then]
                {OBJECTIVES_TWO_VILLAGES_RAZED}
            [/then]
        [/if]

        [if]
            [variable]
                name=number_of_razed_villages
                equals=3
            [/variable]
            [then]
                [message]
                    speaker=Baran
                    message= _ "Orcs have burned too many our villages!"
                [/message]
                [endlevel]
                    result=defeat
                [/endlevel]
            [/then]
        [/if]
    [/event]

    # This event has nothing to do with
    # storyline, it's just there to make
    # a reference.
    [event]
        name=moveto
        first_time_only=no

        [filter]
            [filter_side]
                side=1,2
            [/filter_side]
            [filter_location]
                x,y=32,7
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=balin_met_0
                boolean_equals=yes
            [/variable]
            [then]
                [unit]
                    type=Dwarvish Fighter
                    x,y=33,7
                    name=Balin
                    id=Balin
                    side=4
                [/unit]
                [message]
                    speaker=Balin
                    message= _ "Get out of my house!"
                [/message]
                [move_unit]
                    id=$unit.id
                    to_x,to_y=31,8
                [/move_unit]
                [move_unit]
                    id=Balin
                    to_x,to_y=32,7
                [/move_unit]
                [store_unit]
                    [filter]
                        id=Balin
                    [/filter]
                    kill=yes
                    variable=balin_stored
                [/store_unit]
                [capture_village]
                    x,y=32,7
                    side=0
                [/capture_village]
                {VARIABLE balin_met_1 yes}
                {CLEAR_VARIABLE balin_met_0}
            [/then]
            [elseif]
                [variable]
                    name=balin_met_1
                    boolean_equals=yes
                [/variable]
                [then]
                    [unstore_unit]
                        variable=balin_stored
                        x,y=33,7
                    [/unstore_unit]
                    [message]
                        speaker=Balin
                        message= _ "I told you to get out of my house! Now disappear! Next time I won't be so merciful."
                    [/message]
                    [move_unit]
                        id=$unit.id
                        to_x,to_y=31,8
                    [/move_unit]
                    [move_unit]
                        id=Balin
                        to_x,to_y=32,7
                    [/move_unit]
                    [store_unit]
                        [filter]
                            id=Balin
                        [/filter]
                        kill=yes
                        variable=balin_stored
                    [/store_unit]
                    [capture_village]
                        x,y=32,7
                        side=0
                    [/capture_village]

                    {VARIABLE balin_met_2 yes}
                    {CLEAR_VARIABLE balin_met_1}
                [/then]
            [/elseif]
            [elseif]
                [variable]
                    name=balin_met_2
                    boolean_equals=yes
                [/variable]
                [then]
                    [message]
                        speaker=narrator
                        message= _ "In the house there was noone to be found."
                    [/message]
                    {CLEAR_VARIABLE balin_met_2}
                [/then]
            [/elseif]
        [/if]
    [/event]
    
    [event]
        name=moveto
        first_time_only=no
        [filter]
            [filter_side]
                side=3
            [/filter_side]
            [filter_location]
                terrain=*^Vwm
            [/filter_location]
        [/filter]
        {MODIFY_TERRAIN Rd  $x1 $y1}

        {PLACE_IMAGE scenery/village-human-burned3.png $x1 $y1}

        [message]
            speaker=Baran
            message= _ "We will starve."
        [/message]
        [endlevel]
            result=defeat
        [/endlevel]
    [/event]

    [event]
        name=die
        first_time_only=no
        
        [filter]
            [filter_side]
                side=3
            [/filter_side]
        [/filter]
        [if]
            # This event will trigger when units
            # from side 3 dies and side 3 has 6
            # units in total.
            [have_unit]
                side=3
                count=6
            [/have_unit]
            [then]
                [message]
                    speaker=Grakhas
                    message= _ "Retreat!"
                [/message]
                [store_unit]
                    [filter]
                        id=Grakhas
                    [/filter]
                    kill=yes
                    variable=grakhas_stored
                [/store_unit]
                [endlevel]
                    victory=yes
                    {NEW_GOLD_CARRYOVER 20}
                [/endlevel]
                
                {CLEAR_VARIABLE number_of_razed_villages}
                {CLEAR_VARIABLE balin_stored}
                # Just in case player didn't meet
                # Balin at all, and if player met him
                # once or twice not all variables would
                # be cleared, so this solves that.
                {CLEAR_VARIABLE balin_met_0}
                {CLEAR_VARIABLE balin_met_1}
                {CLEAR_VARIABLE balin_met_2}
            [/then]
        [/if]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Grakhas
        [/filter]
        
        [message]
            speaker=Grakhas
            message= _ "You won't kill me so easily! Men, retreat!"
        [/message]
        
        [move_unit]
            id=Grakhas
            to_x=6
            to_y=1
        [/move_unit]

        [store_unit]
            [filter]
                id=Grakhas
            [/filter]
            kill=yes
            variable=grakhas_stored
        [/store_unit]
        
        [endlevel]
            victory=yes
            {NEW_GOLD_CARRYOVER 20}
        [/endlevel]

        # Of course, we need to clear variables again.
        {CLEAR_VARIABLE number_of_razed_villages}
        {CLEAR_VARIABLE balin_stored}
        {CLEAR_VARIABLE balin_met_0}
        {CLEAR_VARIABLE balin_met_1}
        {CLEAR_VARIABLE balin_met_2}
    [/event]

    {HERO_DEATHS}
[/scenario]
