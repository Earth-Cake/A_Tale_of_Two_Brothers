#textdomain wesnoth-atotb

[scenario]
    name= _ "An Unprecedented Alliance"
    map_file=campaigns/A_Tale_of_Two_Brothers/maps/02_An_Unprecedented_Alliance.map
    id=02_An_Unprecedented_Alliance
    next_scenario=03_The_Siege_of_Glamdrol

    victory_when_enemies_defeated=no

    {DEFAULT_MUSIC_PLAYLIST}
    {DEFAULT_SCHEDULE}
    {TURNS 23 20 17}

    [side]
        side=1
        controller=human
        type=Red Mage
        id=Baran
        name= _ "Baran"
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        canrecruit=yes
        recruit=Spearman, Bowman, Woodsman
        team_name=good_guys
        user_team_name= _ "Humans"
        x,y=33,38
        color=teal

        {GOLD 100 90 80}
    [/side]

    [side]
        side=2
        controller=human
        type=Knight
        id=Arvith
        name= _ "Arvith"
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]
        unrenamable=yes
        canrecruit=yes
        recruit=Spearman, Bowman, Woodsman
        team_name=good_guys
        user_team_name= _ "Humans"
        x,y=41,35
        color=orange

        {GOLD 100 90 80}
    [/side]

    [side]
        side=3
        controller=ai
        type=Orcish Warlord
        id=Barbag
        name= _ "Barbag"
        canrecruit=yes
#ifdef EASY
        recruit=Orcish Grunt, Orcish Archer, Wolf Rider, Goblin Spearman
        [ai]
            recruitment_pattern=fighter,fighter,archer
        [/ai]
#endif
#ifdef NORMAL
        recruit=Orcish Warrior, Orcish Grunt, Orcish Archer, Wolf Rider, Goblin Spearman, Orcish Assassin
        [ai]
            recruitment_pattern=fighter,fighter,archer,scout
        [/ai]
#endif
#ifdef HARD
        recruit=Orcish Grunt, Orcish Archer, Wolf Rider, Orcish Assassin, Orcish Warrior, Goblin Rouser, Goblin Impaler, Orcish Crossbowman
        [ai]
            recruitment_pattern=fighter,fighter,archer,fighter,archer,scout
        [/ai]
#endif
        team_name=bad_guys
        user_team_name= _ "Orcs"
        x,y=12,8

        {GOLD 280 320 370}

        allow_player=no
    [/side]

    [side]
        side=4
        controller=ai
        type=Dark Sorcerer
        id=Darken Volk
        name= _ "Darken Volk"
        [modifications]
            {TRAIT_QUICK}
            {TRAIT_INTELLIGENT}
        [/modifications]
        unrenamable=yes
        canrecruit=yes
        recruit=Ghost
        team_name=good_guys
        user_team_name= _ "Humans"
        x,y=13,28

        {GOLD 100 90 80}

        allow_player=no
    [/side]

    [event]
        name=prestart
        [objectives]
            side=1
            [objective]
                description= _ "Capture every village in inner fortress or"
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Darken Volk"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]
        [objectives]
            side=2
            [objective]
                description= _ "Capture every village in inner fortress or"
                condition=win
            [/objective]
            [objective]
                description= _ "Defeat enemy leader"
                condition=win
            [/objective]
            [objective]
                description= _ "Death of Arvith"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Baran"
                condition=lose
            [/objective]
            [objective]
                description= _ "Death of Darken Volk"
                condition=lose
            [/objective]
            {TURNS_RUN_OUT}

            [gold_carryover]
                bonus=yes
                carryover_percentage=20
            [/gold_carryover]
        [/objectives]

        {CAPTURE_VILLAGES 3 12 8 14}

        # Units guarding the citadel
        {GENERIC_UNIT 3 (Orcish Grunt) 18 18}
        {GENERIC_UNIT 3 (Orcish Grunt) 16 13}
        {GENERIC_UNIT 3 (Orcish Grunt) 21 10}
        {GENERIC_UNIT 3 (Orcish Archer) 27 14}
#ifdef EASY
        {GENERIC_UNIT 3 (Orcish Grunt) 16 13}
#else
        {GENERIC_UNIT 3 (Orcish Warrior) 16 13}
#endif

#ifdef NORMAL
        # Loyal Assassin (Slayer) just like trivia, reference to AOI
        {NAMED_LOYAL_UNIT 3 (Orcish Assassin) 6 17 (Rualsha) ( _ "Rualsha")}
        {GENERIC_UNIT 3 (Goblin Rouser) 20 3}
        {GENERIC_UNIT 3 (Orcish Warrior) 14 6}
        {GENERIC_UNIT 3 (Orcish Grunt) 10 13}
#endif

#ifdef HARD
        # po: translate this unit like Rualsha from AOI
        {NAMED_LOYAL_UNIT 3 (Orcish Slayer) 6 17 (Rualsha) ( _ "Rualsha")}
        {GENERIC_UNIT 3 (Goblin Rouser) 20 3}
        {GENERIC_UNIT 3 (Orcish Warrior) 14 6}
        {GENERIC_UNIT 3 (Orcish Grunt) 10 13}
        {GENERIC_UNIT 3 (Orcish Warrior) 13 19}
        {GENERIC_UNIT 3 (Orcish Archer) 1 17}
        {GENERIC_UNIT 3 (Orcish Warrior) 27 6}
        {GENERIC_UNIT 3 (Orcish Grunt) 16 2}
        {GENERIC_UNIT 3 (Orcish Crossbowman) 8 5}
        {GENERIC_UNIT 3 (Orcish Warrior) 4 12}
        {GENERIC_UNIT 3 (Orcish Warrior) 20 7}
        {GENERIC_UNIT 3 (Orcish Grunt) 4 7}
#endif
        # Now let's put some scenery to improve looks
        # and to use it for an easter egg later.
        {PLACE_IMAGE scenery/castle-ruins.png 12 1}
        {PLACE_IMAGE scenery/castle-ruins2.png 6 12}
        {PLACE_IMAGE scenery/castle-ruins3.png 13 19}
        {PLACE_IMAGE scenery/castle-ruins.png 27 12}
        {PLACE_IMAGE scenery/castle-ruins2.png 5 7}
        {PLACE_IMAGE scenery/castle-ruins3.png 2 16}
        {PLACE_IMAGE scenery/castle-ruins.png 11 6}
        {PLACE_IMAGE scenery/rock1.png 16 10}
        {PLACE_IMAGE scenery/rubble.png 15 14}
        {PLACE_IMAGE scenery/rubble.png 10 1}
        {PLACE_IMAGE scenery/rubble.png 17 3}
        {PLACE_IMAGE scenery/well.png 20 15}
        {PLACE_IMAGE scenery/well.png 6 3}

        # And now for an easter egg;
        {PLACE_IMAGE scenery/rock-cairn2.png 40 4}
    [/event]

    [event]
        name=start
        # Again dialogue about citadel and that there will be lurking something, possibly ancient

        # Brothers would probably know about citadel from their scoutings
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            [filter_side]
                side=1,2
            [/filter_side]
            [filter_location]
                x,y=40,4
            [/filter_location]
        [/filter]
        [message]
            speaker=$unit.id
            message= _ "There is something beneath these stones, I can see it shining! Let me try to move the stones..."
        [/message]

        [delay]
            time=600
        [/delay]

        {REMOVE_IMAGE 40 4}
        {PLACE_IMAGE scenery/rubble.png 40 4}

        [item]
            x,y=40,3
            image=items/armor.png
        [/item]
        [item]
            x,y=41,4
            # Placeholder image:
            image=items/hammer-runic.png
        [/item]

        # After unit moves the stones, it gets tired,
        # and loses all movement points. Reason for this
        # is primarily to prevent unit from taking both
        # items in the same turn player discovered this
        # easter egg. The same will be applied when
        # taking items.
        #
        # Since we want immobility to last only 1 turn, we
        # will have to use [object] to add effect that sets
        # unit's movement points to 0.
        # YET TO BE IMPLEMENTED ##################################################
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            [filter_side]
                side=1,2
            [/filter_side]
            [filter_location]
                x,y=40,3
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=armor_picked
                boolean_equals=no
            [/variable]
            [then]
                [message]
                    speaker=narrator
                    message= _ "This armor will increase its owner physical resistances by 10."
                [/message]
                [message]
                    speaker=narrator
                    message= _ "Do you want to pick it up?"
                    [option]
                        label= _ "Yes, I do."
                        [command]
                            [object]
                                id=hi_armor
                                name= _ "Armor Placeholder Name"
                                image=items/armor.png
                                description= _ "This armor increases its owner physical resistances by 10."
                                [filter]
                                    id=$unit.id
                                [/filter]
                                [effect]
                                    apply_to=resistance
                                    # This increases resistances of unit by 10.
                                    # It is negative because resistances are
                                    # calculated as percent of damage taken,
                                    # and resistance 100 shows in-game as 0%,
                                    # thus -10% resistance means that damage taken
                                    # is 90%. More about that and better explained here:
                                    # https://wiki.wesnoth.org/EffectWML
                                    [resistance]
                                        blade=-10
                                        pierce=-10
                                        impact=-10
                                    [/resistance]
                                [/effect]
                            [/object]
                            [remove_item]
                                x,y=40,3
                            [/remove_item]

                            {VARIABLE armor_picked yes}
                        [/command]
                    [/option]
                    [option]
                        label= _ "No, I don't."
                        # In case unit doesn't take the armor,
                        # player is able to undo the move.
                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no

        [filter]
            [filter_side]
                side=1,2
            [/filter_side]
            [filter_location]
                x,y=41,4
            [/filter_location]
        [/filter]

        [if]
            [variable]
                name=mace_picked
                boolean_equals=no
            [/variable]
            [and]
                [have_unit]
                    id=$unit.id
                    # This filters units listed below and all their
                    # advancements.
                    type_adv_tree=Spearman, Knight
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=narrator
                    message= _ "This mace will grant its owner a new attack."
                [/message]
                [message]
                    speaker=narrator
                    message= _ "Do you want to pick it up?"
                    [option]
                        label= _ "Yes, I do."
                        [command]
                            # This modifies weapon damage depending on
                            # level of the unit that takes it.
                            [if]
                                [have_unit]
                                    level=1
                                    id=$unit.id
                                    # Now, even strong trait has influence
                                    # on damage, so we will nicely filter
                                    # if unit has or doesn't have strong
                                    # trait, and determine damage according to that.
                                    [not]
                                        trait=strong
                                    [/not]
                                [/have_unit]
                                [then]
                                    # Base damage is 8x2 for level 1. With
                                    # strong trait it goes to 9x2.
                                    #
                                    # For code of this macro see macros.cfg
                                    # in this campaign code.
                                    {HI_MACE_EFFECTS 8 2}

                                    [remove_item]
                                        x,y=41,4
                                    [/remove_item]

                                    {VARIABLE maceman_picked_on_level_1 yes}
                                    {VARIABLE mace_picked yes}
                                [/then]
                                [elseif]
                                    # Javelineers base damage is smaller than
                                    # total base damage of this weapon, but choosing
                                    # to give it to a Javelineer doesn't allow player
                                    # to upgrade the weapon to its max damage.
                                    [have_unit]
                                        level=1
                                        id=$unit.id
                                        trait=strong
                                    [/have_unit]
                                    [then]
                                        {HI_MACE_EFFECTS 9 2}

                                        [remove_item]
                                            x,y=41,4
                                        [/remove_item]

                                        {VARIABLE maceman_picked_on_level_1 yes}
                                        {VARIABLE mace_picked yes}
                                    [/then]
                                [/elseif]
                                # This is separated into another [elseif]
                                # tag since [elseif] parent tag allows
                                # only [then] as child tag. [if] tag allows
                                # unlimited number of child [elseif] tags.
                                [elseif]
                                    # Javelineers base damage is smaller than
                                    # total base damage of this weapon, but choosing
                                    # to give it to a Javelineer doesn't allow player
                                    # to upgrade the weapon to its max damage.
                                    [have_unit]
                                        level=2
                                        id=$unit.id
                                        [not]
                                            trait=strong
                                        [/not]
                                    [/have_unit]
                                    [then]
                                        {HI_MACE_EFFECTS 13 2}

                                        [remove_item]
                                            x,y=41,4
                                        [/remove_item]

                                        {VARIABLE maceman_picked_on_level_2 yes}
                                        {VARIABLE mace_picked yes}
                                    [/then]
                                [/elseif]
                                [elseif]
                                    [have_unit]
                                        level=2
                                        id=$unit.id
                                        trait=strong
                                    [/have_unit]
                                    [then]
                                        {HI_MACE_EFFECTS 14 2}

                                        [remove_item]
                                            x,y=41,4
                                        [/remove_item]

                                        {VARIABLE maceman_picked_on_level_2 yes}
                                        {VARIABLE mace_picked yes}
                                    [/then]
                                [/elseif]
                                [elseif]
                                    # Since it is impossible for player to level up any
                                    # unit to level 4 (except Baran, but he is not
                                    # allowed to pick up this weapon), this filters the
                                    # remaining units well enough (also, it's probably
                                    # impossible to get a level 3 by now, but just in case).
                                    [have_unit]
                                        level=3
                                        id=$unit.id
                                        [not]
                                            trait=strong
                                        [/not]
                                    [/have_unit]
                                    [then]
                                        {HI_MACE_EFFECTS 17 2}

                                        [remove_item]
                                            x,y=41,4
                                        [/remove_item]

                                        {VARIABLE maceman_picked_on_level_3 yes}
                                        {VARIABLE mace_picked yes}
                                    [/then]
                                [/elseif]
                                [elseif]
                                    [have_unit]
                                        level=3
                                        id=$unit.id
                                        trait=strong
                                    [/have_unit]
                                    [then]
                                        {HI_MACE_EFFECTS 18 2}

                                        [remove_item]
                                            x,y=41,4
                                        [/remove_item]

                                        {VARIABLE maceman_picked_on_level_3 yes}
                                        {VARIABLE mace_picked yes}
                                    [/then]
                                [/elseif]
                            [/if]
                            # We need to modify id of unit who took
                            # mace in order to later increase its damage.
                            [modify_unit]
                                [filter]
                                    id=$unit.id
                                [/filter]
                                id=Maceman
                            [/modify_unit]
                        [/command]
                    [/option]
                    [option]
                        label= _ "No, I don't."
                        [command]
                            [allow_undo]
                            [/allow_undo]
                        [/command]
                    [/option]
                [/message]
            [/then]
            [else]
                # All units with ranged as primary attack aren't
                # able to use this weapon, mostly for balance reasons,
                # since primary ranged unit using this weapon would
                # be overpowered.
                [message]
                    speaker=$unit.id
                    message= _ "I don't have appropriate training to use this weapon."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=capture
        first_time_only=no
        
        [filter]
            [filter_side]
                team_name=good_guys
            [/filter_side]
        [/filter]
        
        [filter_condition]
            [not]
                [have_location]
                    x=9,6,9,10,11,15,20
                    y=6,10,9,10,9,13,9
                    [not]
                        [filter_owner]
                            team_name=good_guys
                        [/filter_owner]
                    [/not]
                [/have_location]
            [/not]
        [/filter_condition]
            
        [endlevel]
            victory=yes
            {NEW_GOLD_CARRYOVER 20}
        [/endlevel] 
    [/event]

    [event]
        name=enemies defeated
        [endlevel]
            victory=yes
            {NEW_GOLD_CARRYOVER 20}
        [/endlevel]
    [/event]

    {MACEMAN_ADVANCES}
    {HERO_DEATHS}
[/scenario]
